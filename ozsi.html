<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Depo Stok</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#93a4c7; --text:#e9eeff;
      --line:#22305a; --good:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --btn:#1f2a4d; --btn2:#2a3a6b; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #22305a 0%, transparent 55%),
                  radial-gradient(900px 500px at 95% 10%, #1c3d7a 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:24px;
    }
    .wrap{max-width:1100px; margin:0 auto;}
    header{
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between;
      flex-wrap:wrap; margin-bottom:16px;
    }
    h1{font-size:22px; margin:0; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:13px; margin-top:4px}
    .grid{
      display:grid; grid-template-columns: 360px 1fr; gap:16px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(147,164,199,.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(147,164,199,.22);
      background: rgba(18,26,51,.55);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(45,212,191,.55); box-shadow:0 0 0 3px rgba(45,212,191,.12)}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:1px solid rgba(147,164,199,.25);
      background: var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
    }
    button:hover{background:var(--btn2)}
    button:active{transform: translateY(1px)}
    .primary{border-color: rgba(45,212,191,.5); background: rgba(45,212,191,.12)}
    .danger{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.12)}
    .ghost{background: transparent}
    .tiny{padding:7px 9px; border-radius:10px; font-size:12px}
    .tools{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .tools .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:flex; gap:10px; align-items:center; padding:8px 10px;
      border:1px solid rgba(147,164,199,.22);
      border-radius:999px;
      background: rgba(18,26,51,.4);
      color: var(--muted);
      font-size:12px;
    }
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:10px 10px; border-bottom:1px solid rgba(147,164,199,.18);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(147,164,199,.12);
      vertical-align:middle;
    }
    tbody tr:hover{background: rgba(147,164,199,.06)}
    .right{display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 8px; border-radius:999px; font-size:12px; font-weight:700;
      border:1px solid rgba(147,164,199,.22);
      background: rgba(18,26,51,.45);
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .muted{color:var(--muted)}
    .footerNote{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35}
    .toast{
      position: fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(18,26,51,.92);
      border:1px solid rgba(147,164,199,.22);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-size: 13px;
      opacity: 0; pointer-events:none;
      transition: .18s opacity, .18s transform;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .kpi .box{
      flex:1; min-width:120px;
      border:1px solid rgba(147,164,199,.18);
      background: rgba(18,26,51,.35);
      border-radius: 14px;
      padding:10px 12px;
    }
    .kpi .num{font-size:18px; font-weight:800}
    .kpi .lbl{font-size:12px; color:var(--muted); margin-top:2px}
    .sep{height:1px; background: rgba(147,164,199,.15); margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Depo Stok</h1>
        <div class="sub">Tarayƒ±cƒ± i√ßinde √ßalƒ±≈üan mini stok uygulamasƒ± (localStorage)</div>
      </div>
      <div class="pill" id="clock">üïí</div>
    </header>

    <div class="grid">
      <!-- LEFT: Form -->
      <section class="card">
        <div class="badge"><span class="dot" id="statusDot"></span><span id="modeText">Yeni √ºr√ºn ekle</span></div>

        <label>√úr√ºn Adƒ±</label>
        <input id="name" placeholder="√ñrn: 10mm Halat" autocomplete="off" />

        <div class="row">
          <div>
            <label>Adet</label>
            <input id="qty" type="number" inputmode="numeric" min="0" placeholder="0" />
          </div>
          <div>
            <label>D√º≈ü√ºk Stok E≈üiƒüi</label>
            <input id="threshold" type="number" inputmode="numeric" min="0" placeholder="√ñrn: 5" />
          </div>
        </div>

        <label>Not (opsiyonel)</label>
        <input id="note" placeholder="√ñrn: Raf A3" autocomplete="off" />

        <div class="btnrow">
          <button class="primary" id="saveBtn">Kaydet</button>
          <button class="ghost" id="resetBtn">Temizle</button>
          <button class="danger" id="deleteBtn" style="display:none;">Sil</button>
        </div>

        <div class="sep"></div>

        <div class="btnrow">
          <button id="exportBtn">CSV Dƒ±≈üa Aktar</button>
          <button id="importBtn">CSV ƒ∞√ße Aktar</button>
          <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none;" />
          <button class="danger" id="wipeBtn">T√ºm√ºn√º Sƒ±fƒ±rla</button>
        </div>

        <div class="footerNote">
          ƒ∞pucu: Listeden bir √ºr√ºne tƒ±klarsan d√ºzenleme moduna ge√ßer. ‚Äú+1 / -1‚Äù ile hƒ±zlƒ± sayƒ±m.
        </div>

        <div class="kpi" id="kpis"></div>
      </section>

      <!-- RIGHT: Table -->
      <section class="card">
        <div class="tools">
          <div class="left">
            <input id="search" placeholder="Ara: √ºr√ºn adƒ± / not" style="width:260px" />
            <select id="sort" style="width:200px">
              <option value="name_asc">Sƒ±rala: Ada g√∂re (A‚ÜíZ)</option>
              <option value="name_desc">Sƒ±rala: Ada g√∂re (Z‚ÜíA)</option>
              <option value="qty_desc">Sƒ±rala: Adet (√ßok‚Üíaz)</option>
              <option value="qty_asc">Sƒ±rala: Adet (az‚Üí√ßok)</option>
              <option value="updated_desc">Sƒ±rala: Son g√ºncellenen</option>
              <option value="created_desc">Sƒ±rala: Son eklenen</option>
            </select>
            <label class="pill" style="cursor:pointer;">
              <input id="onlyLow" type="checkbox" style="width:auto; margin:0 6px 0 0; accent-color: var(--good);" />
              Sadece d√º≈ü√ºk stok
            </label>
          </div>
          <div class="pill" id="countPill">0 √ºr√ºn</div>
        </div>

        <div style="overflow:auto; border-radius:14px; border:1px solid rgba(147,164,199,.12);">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px;">√úr√ºn</th>
                <th style="width:110px;">Adet</th>
                <th style="min-width:180px;">Not</th>
                <th style="width:150px;">Durum</th>
                <th style="width:220px; text-align:right;">ƒ∞≈ülem</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="footerNote">
          Veriler bu cihazda saklanƒ±r. Ba≈üka cihazda kullanmak i√ßin CSV dƒ±≈üa aktarƒ±p i√ße aktarabilirsin.
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== Utilities =====
    const $ = (s) => document.querySelector(s);
    const fmtDate = (ms) => new Date(ms).toLocaleString("tr-TR");
    const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36);

    function toast(msg){
      const el = $("#toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>el.classList.remove("show"), 1600);
    }

    // ===== Storage =====
    const KEY = "depo_stok_v1";
    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.warn(e);
        return [];
      }
    }
    function save(items){
      localStorage.setItem(KEY, JSON.stringify(items));
    }

    // ===== State =====
    let items = load(); // {id,name,qty,threshold,note,createdAt,updatedAt}
    let selectedId = null;

    // ===== DOM refs =====
    const nameEl = $("#name");
    const qtyEl = $("#qty");
    const thresholdEl = $("#threshold");
    const noteEl = $("#note");
    const saveBtn = $("#saveBtn");
    const resetBtn = $("#resetBtn");
    const deleteBtn = $("#deleteBtn");
    const wipeBtn = $("#wipeBtn");

    const searchEl = $("#search");
    const sortEl = $("#sort");
    const onlyLowEl = $("#onlyLow");

    const tbody = $("#tbody");
    const countPill = $("#countPill");
    const modeText = $("#modeText");
    const statusDot = $("#statusDot");
    const kpis = $("#kpis");

    // ===== Render =====
    function getStatus(it){
      const th = Number.isFinite(it.threshold) ? it.threshold : 0;
      if (it.qty <= 0) return {label:"Bitti", cls:"bad"};
      if (it.qty <= th) return {label:"Azaldƒ±", cls:"warn"};
      return {label:"ƒ∞yi", cls:"good"};
    }

    function filtered(){
      const q = searchEl.value.trim().toLowerCase();
      const onlyLow = onlyLowEl.checked;

      let list = items.filter(it => {
        const hay = (it.name + " " + (it.note||"")).toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (onlyLow){
          const th = Number.isFinite(it.threshold) ? it.threshold : 0;
          if (!(it.qty <= th)) return false;
        }
        return true;
      });

      const sort = sortEl.value;
      const byName = (a,b)=> a.name.localeCompare(b.name, "tr", {sensitivity:"base"});
      if (sort==="name_asc") list.sort(byName);
      else if (sort==="name_desc") list.sort((a,b)=>byName(b,a));
      else if (sort==="qty_desc") list.sort((a,b)=>b.qty-a.qty || byName(a,b));
      else if (sort==="qty_asc") list.sort((a,b)=>a.qty-b.qty || byName(a,b));
      else if (sort==="updated_desc") list.sort((a,b)=>b.updatedAt-a.updatedAt);
      else if (sort==="created_desc") list.sort((a,b)=>b.createdAt-a.createdAt);

      return list;
    }

    function render(){
      const list = filtered();
      tbody.innerHTML = "";

      for(const it of list){
        const st = getStatus(it);
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <div style="font-weight:800">${escapeHtml(it.name)}</div>
            <div class="muted" style="font-size:12px">G√ºncellendi: ${escapeHtml(fmtDate(it.updatedAt))}</div>
          </td>
          <td style="font-weight:800">${it.qty}</td>
          <td class="muted">${escapeHtml(it.note || "-")}</td>
          <td>
            <span class="badge">
              <span class="dot ${st.cls}"></span>
              ${st.label}
            </span>
            <div class="muted" style="font-size:12px; margin-top:6px">E≈üik: ${it.threshold ?? 0}</div>
          </td>
          <td>
            <div class="right">
              <button class="tiny" data-act="inc" data-id="${it.id}">+1</button>
              <button class="tiny" data-act="dec" data-id="${it.id}">-1</button>
              <button class="tiny" data-act="edit" data-id="${it.id}">D√ºzenle</button>
            </div>
          </td>
        `;

        // Click row to edit
        tr.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if (btn) return; // buttons handle separately
          select(it.id);
        });

        tbody.appendChild(tr);
      }

      countPill.textContent = `${list.length} √ºr√ºn`;

      // KPIs
      const total = items.length;
      const low = items.filter(it=>{
        const th = Number.isFinite(it.threshold) ? it.threshold : 0;
        return it.qty <= th;
      }).length;
      const out = items.filter(it=>it.qty<=0).length;
      const sum = items.reduce((a,it)=>a + (Number(it.qty)||0), 0);

      kpis.innerHTML = `
        <div class="box"><div class="num">${total}</div><div class="lbl">Toplam √ºr√ºn</div></div>
        <div class="box"><div class="num">${sum}</div><div class="lbl">Toplam adet</div></div>
        <div class="box"><div class="num">${low}</div><div class="lbl">D√º≈ü√ºk stok</div></div>
        <div class="box"><div class="num">${out}</div><div class="lbl">Biten</div></div>
      `;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // ===== CRUD =====
    function clearForm(){
      selectedId = null;
      nameEl.value = "";
      qtyEl.value = "";
      thresholdEl.value = "";
      noteEl.value = "";
      modeText.textContent = "Yeni √ºr√ºn ekle";
      statusDot.className = "dot";
      deleteBtn.style.display = "none";
      nameEl.focus();
    }

    function select(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      selectedId = id;
      nameEl.value = it.name;
      qtyEl.value = it.qty;
      thresholdEl.value = it.threshold ?? 0;
      noteEl.value = it.note || "";
      modeText.textContent = "√úr√ºn d√ºzenle";
      statusDot.className = "dot warn";
      deleteBtn.style.display = "inline-flex";
      toast("D√ºzenleme moduna ge√ßildi");
    }

    function upsert(){
      const name = nameEl.value.trim();
      const qty = Number(qtyEl.value);
      const threshold = Number(thresholdEl.value || 0);
      const note = noteEl.value.trim();

      if(!name){ toast("√úr√ºn adƒ± bo≈ü olamaz"); nameEl.focus(); return; }
      if(!Number.isFinite(qty) || qty < 0){ toast("Adet 0 veya daha b√ºy√ºk olmalƒ±"); qtyEl.focus(); return; }
      if(!Number.isFinite(threshold) || threshold < 0){ toast("E≈üik 0 veya daha b√ºy√ºk olmalƒ±"); thresholdEl.focus(); return; }

      const now = Date.now();

      if(selectedId){
        const it = items.find(x=>x.id===selectedId);
        if(!it) { clearForm(); return; }
        it.name = name;
        it.qty = qty;
        it.threshold = threshold;
        it.note = note;
        it.updatedAt = now;
        save(items);
        toast("G√ºncellendi");
      }else{
        // If same name exists, offer merge behavior: update existing
        const existing = items.find(x=>x.name.toLowerCase()===name.toLowerCase());
        if(existing){
          existing.qty = qty;
          existing.threshold = threshold;
          existing.note = note;
          existing.updatedAt = now;
          save(items);
          toast("Aynƒ± isim bulundu: g√ºncellendi");
        }else{
          items.unshift({
            id: uid(),
            name,
            qty,
            threshold,
            note,
            createdAt: now,
            updatedAt: now
          });
          save(items);
          toast("Eklendi");
        }
      }

      render();
      clearForm();
    }

    function removeSelected(){
      if(!selectedId) return;
      const it = items.find(x=>x.id===selectedId);
      if(!it) return;
      if(!confirm(`Silinsin mi?\n\n${it.name}`)) return;
      items = items.filter(x=>x.id!==selectedId);
      save(items);
      toast("Silindi");
      render();
      clearForm();
    }

    function changeQty(id, delta){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      it.qty = Math.max(0, (Number(it.qty)||0) + delta);
      it.updatedAt = Date.now();
      save(items);
      render();
    }

    // ===== CSV =====
    function toCSV(){
      // id,name,qty,threshold,note,createdAt,updatedAt
      const header = ["id","name","qty","threshold","note","createdAt","updatedAt"];
      const rows = items.map(it => header.map(k => csvEscape(it[k] ?? "")).join(","));
      return header.join(",") + "\n" + rows.join("\n");
    }
    function csvEscape(v){
      const s = String(v);
      if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }
    function downloadCSV(){
      const blob = new Blob([toCSV()], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `stok_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      toast("CSV indirildi");
    }

    function parseCSV(text){
      // Simple CSV parser supporting quoted fields
      const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
      if(lines.length < 1) return [];
      const header = splitCSVLine(lines[0]).map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx)=> obj[h] = cols[idx] ?? "");
        out.push(obj);
      }
      return out;
    }
    function splitCSVLine(line){
      const res = [];
      let cur = "";
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(inQ){
          if(ch === '"'){
            if(line[i+1] === '"'){ cur+='"'; i++; }
            else inQ = false;
          }else cur += ch;
        }else{
          if(ch === '"') inQ = true;
          else if(ch === ","){ res.push(cur); cur=""; }
          else cur += ch;
        }
      }
      res.push(cur);
      return res;
    }

    async function importCSVFile(file){
      const text = await file.text();
      const rows = parseCSV(text);

      // Accept both with/without id columns (fallback by name)
      const now = Date.now();
      let added=0, updated=0;

      for(const r of rows){
        const name = (r.name ?? r["√úr√ºn"] ?? r["urun"] ?? r["product"] ?? "").toString().trim();
        if(!name) continue;

        const qty = Number(r.qty ?? r["Adet"] ?? r["adet"] ?? 0);
        const threshold = Number(r.threshold ?? r["E≈üik"] ?? r["esik"] ?? 0);
        const note = (r.note ?? r["Not"] ?? r["not"] ?? "").toString().trim();

        const existing = items.find(x=>x.name.toLowerCase()===name.toLowerCase());
        if(existing){
          existing.qty = Number.isFinite(qty) ? Math.max(0, qty) : existing.qty;
          existing.threshold = Number.isFinite(threshold) ? Math.max(0, threshold) : (existing.threshold ?? 0);
          existing.note = note || existing.note || "";
          existing.updatedAt = now;
          updated++;
        }else{
          items.unshift({
            id: r.id ? String(r.id) : uid(),
            name,
            qty: Number.isFinite(qty) ? Math.max(0, qty) : 0,
            threshold: Number.isFinite(threshold) ? Math.max(0, threshold) : 0,
            note,
            createdAt: Number(r.createdAt)||now,
            updatedAt: Number(r.updatedAt)||now
          });
          added++;
        }
      }

      save(items);
      render();
      toast(`ƒ∞√ße aktarƒ±ldƒ±: +${added} / g√ºncellenen ${updated}`);
    }

    // ===== Events =====
    saveBtn.addEventListener("click", upsert);
    resetBtn.addEventListener("click", clearForm);
    deleteBtn.addEventListener("click", removeSelected);

    searchEl.addEventListener("input", render);
    sortEl.addEventListener("change", render);
    onlyLowEl.addEventListener("change", render);

    tbody.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(act==="inc"){ changeQty(id, +1); toast("+1"); }
      if(act==="dec"){ changeQty(id, -1); toast("-1"); }
      if(act==="edit"){ select(id); }
      e.stopPropagation();
    });

    $("#exportBtn").addEventListener("click", downloadCSV);
    $("#importBtn").addEventListener("click", ()=>$("#fileInput").click());
    $("#fileInput").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      await importCSVFile(file);
      e.target.value = "";
    });

    wipeBtn.addEventListener("click", ()=>{
      if(!confirm("T√ºm stok verileri silinsin mi?")) return;
      items = [];
      save(items);
      render();
      clearForm();
      toast("Hepsi sƒ±fƒ±rlandƒ±");
    });

    // Enter to save (UX)
    [nameEl, qtyEl, thresholdEl, noteEl].forEach(el=>{
      el.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){ upsert(); }
      });
    });

    // Clock
    function tick(){
      $("#clock").textContent = "üïí " + new Date().toLocaleString("tr-TR");
    }
    setInterval(tick, 1000); tick();

    // Init
    render();
    clearForm();
  </script>
</body>
</html>
